<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gradient Tweet</title>
  <style>
    :root {
      --card-bg: #fff;
      --text: #0f1419;
      --muted: #536471;
      --link: #1d9bf0;
      --shadow: 0 10px 30px rgba(0,0,0,0.15);
      --radius: 16px;
    }
    html, body {
      margin: 0;
      padding: 0;
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      background: transparent;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .wrap {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      gap: 20px;
      box-sizing: border-box;
    }
    .bg {
      width: 100%;
      max-width: 600px;
      min-height: 300px;
      padding: 40px;
      border-radius: 24px;
      background: linear-gradient(135deg,#FF6B6B,#FFE66D);
      transition: background 200ms ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    .tweet-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px 32px 20px;
      width: 100%;
      max-width: 520px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      overflow: hidden;
    }
    .controls-panel {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 20px;
      width: 100%;
      max-width: 600px;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      box-sizing: border-box;
    }
    .tweet-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .tweet-header {
      display: flex;
      align-items: center;
      padding-bottom: 8px;
    }
    .tweet-main {
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 8px 0;
    }
    .tweet-footer {
      display: flex;
      align-items: flex-end;
      padding-top: 8px;
    }
    .row { display: flex; align-items: center; gap: 12px; }
    .avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; }
    .name { color: var(--text); font-weight: 700; }
    .handle { color: var(--muted); }
    .verified { color: #1d9bf0; margin-left: 4px; display:inline-flex; align-items:center; font-size:0; }
    .verified::before { content:''; width:18px; height:18px; display:inline-block; background-repeat:no-repeat; background-position:center; background-size:contain; background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%231d9bf0' d='M12 2.25l2.39 1.3 2.63-.09 1.55 2.2 2.42 1.22-.5 2.6 1.42 2.19-1.9 1.9.2 2.63-2.5.94-1.37 2.24-2.62-.24-2.23 1.38-2.07-1.74-2.62.24-1.37-2.24-2.5-.94.2-2.63-1.9-1.9 1.42-2.19-.5-2.6 2.42-1.22 1.55-2.2 2.63.09L12 2.25z'/><path fill='%23fff' d='M10.2 13.5l-2-2 1.4-1.4 1.3 1.3 3.4-3.4 1.4 1.4-4.8 4.8z'/></svg>"); }
    .content {
      color: var(--text);
      font-size: 20px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
      width: 100%;
      font-weight: 400;
      max-height: 400px;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    /* Custom scrollbar for content area */
    .content::-webkit-scrollbar {
      width: 4px;
    }
    .content::-webkit-scrollbar-track {
      background: transparent;
    }
    .content::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.1);
      border-radius: 2px;
    }
    .content::-webkit-scrollbar-thumb:hover {
      background: rgba(0,0,0,0.2);
    }
    .meta { color: var(--muted); font-size: 14px; }
    .meta a { color: var(--link); text-decoration: none; }
    .controls {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      width: 100%;
    }
    .controls .btn {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      transition: all 150ms ease;
    }
    .controls .btn:hover {
      background: #f9fafb;
    }
    .controls .btn.primary {
      background: #000;
      color: #fff;
      border-color: #000;
    }
    .controls .btn.primary:hover {
      background: #333;
    }
    .sliders {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: center;
      flex: 1;
    }
    .sliders label {
      display: flex;
      flex-direction: row;
      gap: 8px;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }
    input[type="range"]{
      accent-color: #1d9bf0;
      width: 100px;
    }
    .color-bar {
      display: flex;
      flex-direction: row;
      gap: 12px;
      align-items: center;
    }
    .color-bar label {
      display: flex;
      flex-direction: row;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
      align-items: center;
    }
    .color-bar input[type="color"] {
      width: 50px;
      height: 32px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 6px;
      cursor: pointer;
    }
    .grad-thumbs { display:none; gap:8px; flex-wrap:wrap; }
    .grad-thumbs button { width: 28px; height: 28px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.1); cursor:pointer; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div id="bg" class="bg">
      <div id="card" class="tweet-card">
        <div class="tweet-content">
          <div class="tweet-header">
            <div class="row">
              <img id="avatar" class="avatar" src="https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png" />
              <div style="display:flex;flex-direction:column;">
                <div style="display:flex;align-items:center;gap:6px;">
                  <span id="name" class="name">Twitter User</span>
                  <span id="verified" class="verified" title="Verified"></span>
                </div>
                <span id="handle" class="handle">@twitter_user</span>
              </div>
            </div>
          </div>
          <div class="tweet-main">
            <div id="content" class="content">Type your tweet content</div>
          </div>
          <div class="tweet-footer">
            <div class="meta"><span id="date"></span></div>
          </div>
        </div>
      </div>
    </div>
    <div class="controls-panel">
      <div class="controls">
        <div class="sliders">
          <label>Angle <input id="angle" type="range" min="0" max="360" value="135"></label>
          <label>Mix <input id="mix" type="range" min="0" max="100" value="100"></label>
        </div>
        <button id="download" class="btn">⬇️ Download</button>
        <button id="share" class="btn primary">Share to X</button>
      </div>
      <div class="color-bar">
        <label>Color 1 <input id="color1" type="color" value="#FF6B6B"></label>
        <label>Color 2 <input id="color2" type="color" value="#FFE66D"></label>
        <button id="random" class="btn">⏮️ Random ⏭️</button>
      </div>
      <div id="gradThumbs" class="grad-thumbs"></div>
    </div>
  </div>
  <script>
    // All gradients - loaded from structured content
    let ALL_GRADIENTS = [];
    let SERVER_URL = '';

    const qs = (s)=>document.querySelector(s);
    const bg = qs('#bg');
    const avatar = qs('#avatar');
    const nameEl = qs('#name');
    const verifiedEl = qs('#verified');
    const handleEl = qs('#handle');
    const contentEl = qs('#content');
    const dateEl = qs('#date');
    const angleEl = qs('#angle');
    const mixEl = qs('#mix');
    const color1El = qs('#color1');
    const color2El = qs('#color2');
    const randomBtn = qs('#random');
    const dlBtn = qs('#download');
    const shareBtn = qs('#share');
    const thumbs = qs('#gradThumbs');

    const fmtDate = (iso)=>{
      try{
        const d = new Date(iso || Date.now());
        const time = d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'});
        const date = d.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'});
        return `${time} · ${date}`;
      }catch{ return ''; }
    };

    let currentColors = [];
    function setBg(angle, colors, mix=1, updateColorInputs=true){
      const [c1,c2] = colors;
      const mid = mix < 1 ? Math.round(mix*100) : 100;
      bg.style.background = `linear-gradient(${angle}deg, ${c1} 0%, ${c2} ${mid}%)`;
      currentColors = [c1, c2];
      
      // Update color inputs to match current colors (only when not triggered by color input)
      if (updateColorInputs && color1El && color1El.value !== c1) color1El.value = c1;
      if (updateColorInputs && color2El && color2El.value !== c2) color2El.value = c2;
    }

    function applyData(data){
      // Load gradients from structured content
      if (data.gradients && Array.isArray(data.gradients)) {
        ALL_GRADIENTS = data.gradients;
        console.log('✅ Loaded gradients from structured content:', ALL_GRADIENTS.length);
      }

      // Load server URL for API calls
      if (data.serverUrl) {
        SERVER_URL = data.serverUrl;
        console.log('✅ Server URL loaded:', SERVER_URL);
      }

      const profile = data.profile || {};
      nameEl.textContent = profile.name || 'Twitter User';
      handleEl.textContent = `@${profile.handle || 'twitter_user'}`;
      avatar.src = profile.avatar || avatar.src;

      // Verified badge is always visible

      contentEl.textContent = data.tweetContent || '';
      dateEl.textContent = fmtDate(data.timestamp);

      // Only apply gradient if we have gradients loaded
      if (ALL_GRADIENTS.length > 0) {
        const idx = Number(data.gradientIndex ?? 0) || 0;
        const g = ALL_GRADIENTS[Math.max(0, Math.min(ALL_GRADIENTS.length - 1, idx))];
        angleEl.value = g.angle;
        setBg(g.angle, g.colors, 1);
        currentColors = g.colors.slice();
      }
    }

    angleEl.addEventListener('input',()=>{
      setBg(Number(angleEl.value), currentColors, Number(mixEl.value)/100);
    });
    mixEl.addEventListener('input',()=>{
      setBg(Number(angleEl.value), currentColors, Number(mixEl.value)/100);
    });
    color1El.addEventListener('input',()=>{
      const newColors = [color1El.value, color2El.value];
      currentColors = newColors;
      setBg(Number(angleEl.value), newColors, Number(mixEl.value)/100, false);
    });
    color2El.addEventListener('input',()=>{
      const newColors = [color1El.value, color2El.value];
      currentColors = newColors;
      setBg(Number(angleEl.value), newColors, Number(mixEl.value)/100, false);
    });
    randomBtn.addEventListener('click',()=>{
      if (ALL_GRADIENTS.length > 0) {
        const i = Math.floor(Math.random()*ALL_GRADIENTS.length);
        const g = ALL_GRADIENTS[i];
        angleEl.value = g.angle;

        // Randomize mix value between 50% and 100%
        const randomMix = Math.floor(Math.random() * 51) + 50; // 50-100 range
        mixEl.value = randomMix;

        setBg(g.angle, g.colors, randomMix/100);
      }
    });
    shareBtn.addEventListener('click', async ()=>{
      const bgNode = document.getElementById('bg');

      try{
        // Capture just the gradient background with the tweet card
        const canvas = await html2canvas(bgNode, {
          backgroundColor: null,
          scale: 2,
          useCORS: true,
          allowTaint: true,
          logging: false
        });
        const dataUrl = canvas.toDataURL('image/png');

        // Upload to Cloudinary using absolute server URL
        const uploadUrl = SERVER_URL + '/api/upload-image';
        console.log('📤 Uploading to:', uploadUrl);

        const res = await fetch(uploadUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: dataUrl })
        });
        const out = await res.json();
        if (out && out.url){
          // Get the tweet content to include in the share
          const tweetContent = contentEl.textContent || '';

          // Create share URL with Twitter Card meta tags (for image preview)
          const shareUrl = SERVER_URL + '/share/' + out.public_id;
          const shareText = tweetContent ? `${tweetContent} ${shareUrl}` : shareUrl;
          const encodedText = encodeURIComponent(shareText);

          console.log('🐦 Opening Twitter with share URL:', shareUrl);

          // Twitter will automatically fetch and display the image from the share page
          const u = `https://twitter.com/intent/tweet?text=${encodedText}`;
          window.open(u,'_blank','noopener,noreferrer');
        }
      }catch(e){
        console.error('Share failed', e);
      }
    });
    dlBtn.addEventListener('click', async ()=>{
      const bgNode = document.getElementById('bg');

      try {
        // Capture just the gradient background with the tweet card
        const canvas = await html2canvas(bgNode, {
          backgroundColor: null,
          scale: 2,
          useCORS: true,
          allowTaint: true,
          logging: false
        });
        const dataUrl = canvas.toDataURL('image/png');

        // Store tweet content and data URL for sharing
        const tweetContent = contentEl.textContent || '';

        // Replace entire widget with the generated image
        document.body.innerHTML = `
          <div style="
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #000;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden;
          ">
            <img
              src="${dataUrl}"
              style="
                max-width: 100%;
                max-height: calc(100vh - 150px);
                object-fit: contain;
                border-radius: 8px;
              "
              alt="Tweet gradient image"
            >
            <p style="
              color: #fff;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              font-size: 16px;
              margin-top: 20px;
              text-align: center;
            ">
              Right-click to copy or save the image!
            </p>
          </div>
        `;

        console.log('✅ Image rendered in widget - user can now copy/save');
      } catch(e) {
        console.error('Image generation failed', e);
      }
    });
    // Apps SDK hydration - listen for 'openai:set_globals' event (official pattern)
    function initFromOpenAI() {
      // Try immediately first (window.openai might already be available)
      if (typeof window !== 'undefined' && window.openai && window.openai.toolOutput) {
        console.log('✅ window.openai.toolOutput already available');
        applyData(window.openai.toolOutput);
        return;
      }

      // Listen for the Apps SDK event (matches pattern from React widgets)
      console.log('⏳ Waiting for openai:set_globals event...');

      let eventReceived = false;

      window.addEventListener('openai:set_globals', (event) => {
        eventReceived = true;
        console.log('✅ Received openai:set_globals event', event);

        // Check if toolOutput is in the event detail or on window.openai
        const toolOutput = event.detail?.globals?.toolOutput || window.openai?.toolOutput;

        if (toolOutput) {
          console.log('✅ Hydrating widget from toolOutput', toolOutput);
          applyData(toolOutput);
        } else {
          console.warn('⚠️ Event received but no toolOutput found');
          useFallbackData();
        }
      }, { once: true, passive: true }); // once: true = auto-remove listener after first call

      // Fallback timeout: if event doesn't arrive in 5 seconds, use fallback
      setTimeout(() => {
        if (!eventReceived && !(window.openai && window.openai.toolOutput)) {
          console.warn('⚠️ Apps SDK event timeout after 5s, using fallback data');
          useFallbackData();
        }
      }, 5000);
    }

    function useFallbackData() {
      // Fallback: parse query params for local dev/testing
      try {
        const p = new URLSearchParams(location.search);
        const mock = {
          tweetContent: p.get('text') || 'Hello world!',
          gradientIndex: Number(p.get('g')||0),
          profile: {
            name: p.get('name')||'Twitter User',
            handle: p.get('handle')||'twitter_user',
            avatar: p.get('avatar')||'https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png'
          },
          timestamp: new Date().toISOString(),
          // Fallback gradients for local testing
          gradients: [
            { name: 'Sunset Blaze', colors: ['#FF6B6B','#FFE66D'], angle: 135 },
            { name: 'Ocean Deep', colors: ['#00D4FF','#0099FF'], angle: 180 },
            { name: 'Forest Dawn', colors: ['#11998E','#38EF7D'], angle: 120 },
          ]
        };
        console.log('⚠️ Using fallback data from query params');
        applyData(mock);
      } catch (e) {
        console.error('❌ Failed to apply fallback data:', e);
      }
    }

    // Start the application when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFromOpenAI);
    } else {
      initFromOpenAI();
    }
  </script>
  </body>
  </html>
